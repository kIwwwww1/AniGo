# Функция редактирования фонового изображения

## Обзор

Реализована новая функция редактирования фонового изображения профиля с интерактивным редактором. Теперь пользователи могут настраивать, как будет отображаться фоновое изображение под аватаркой, перед его загрузкой в S3.

## Новые возможности

### Для пользователей

1. **Интерактивный редактор изображений**
   - Открывается автоматически после выбора файла
   - Предварительный просмотр в реальном времени
   - Управление мышью (drag & drop для позиционирования)

2. **Настройки отображения**
   - **Масштаб**: от 50% до 200% (ползунок или колесо мыши)
   - **Позиция X**: горизонтальное смещение 0-100%
   - **Позиция Y**: вертикальное смещение 0-100%

3. **Удобный интерфейс**
   - Перетаскивание изображения мышью
   - Три ползунка для точной настройки
   - Кнопка "Сбросить" для возврата к начальным значениям
   - Кнопки "Отмена" и "Применить"

### Технические детали

#### Frontend

**Новые компоненты:**
- `ImageEditor.jsx` - компонент редактора изображений
- `ImageEditor.css` - стили для редактора

**Обновленные компоненты:**
- `SettingsPage.jsx` - интеграция редактора
- `UserProfilePage.jsx` - отображение фона с настройками
- `api.js` - обновленный метод загрузки с параметрами

#### Backend

**Обновленные модели:**
- `user_profile_settings.py` - добавлены поля для настроек отображения
  - `background_scale` (INT, default: 100)
  - `background_position_x` (INT, default: 50)
  - `background_position_y` (INT, default: 50)

**Обновленные схемы:**
- `user.py` - добавлены поля в схему настроек профиля с валидацией

**Обновленные API эндпоинты:**
- `PATCH /user/background-image` - принимает параметры отображения:
  - `scale` (query param, 50-200)
  - `position_x` (query param, 0-100)
  - `position_y` (query param, 0-100)

## Как использовать

### Для пользователей

1. Перейдите в настройки профиля
2. Откройте панель настроек профиля (иконка шестеренки)
3. В разделе "Фоновое изображение под аватаркой" нажмите "Загрузить изображение"
4. Выберите файл изображения (требования: 5 МБ макс, точно 1200x350 px)
5. В открывшемся редакторе:
   - Перетаскивайте изображение мышью для позиционирования
   - Используйте ползунок "Масштаб" для изменения размера
   - Используйте ползунки "Позиция X/Y" для точной настройки
   - Нажмите "Сбросить" для возврата к начальным значениям
   - Нажмите "Применить" для загрузки изображения
6. Изображение загрузится в S3 с выбранными настройками
7. Фон сразу отобразится под вашей аватаркой

### Для разработчиков

#### Установка

1. **Применить миграцию базы данных:**
   ```bash
   cd backend
   python migrations/run_background_display_settings_migration.py
   ```

2. **Перезапустить backend:**
   ```bash
   docker-compose restart backend
   ```

3. **Пересобрать frontend (если нужно):**
   ```bash
   cd frontend
   npm run build
   ```

#### API использование

```javascript
// Загрузка изображения с настройками
const settings = {
  scale: 120,        // 120% масштаб
  positionX: 30,     // 30% слева
  positionY: 60      // 60% сверху
}

const response = await userAPI.uploadBackgroundImage(file, settings)
// Ответ:
// {
//   message: "Фоновое изображение успешно загружено",
//   background_image_url: "https://...",
//   background_scale: 120,
//   background_position_x: 30,
//   background_position_y: 60
// }
```

#### Компонент ImageEditor

```jsx
import ImageEditor from '../components/ImageEditor'

// В вашем компоненте:
const [showEditor, setShowEditor] = useState(false)
const [imageFile, setImageFile] = useState(null)

const handleConfirm = ({ file, settings }) => {
  // settings содержит: { scale, positionX, positionY }
  // Загрузите файл с настройками в API
}

// Рендер:
{showEditor && (
  <ImageEditor
    imageFile={imageFile}
    onConfirm={handleConfirm}
    onCancel={() => setShowEditor(false)}
  />
)}
```

## Структура файлов

```
frontend/
├── src/
│   ├── components/
│   │   ├── ImageEditor.jsx       # Новый компонент редактора
│   │   └── ImageEditor.css       # Стили редактора
│   ├── pages/
│   │   ├── SettingsPage.jsx      # Обновлен
│   │   └── UserProfilePage.jsx   # Обновлен
│   └── services/
│       └── api.js                # Обновлен

backend/
├── src/
│   ├── models/
│   │   └── user_profile_settings.py  # Обновлена модель
│   ├── schemas/
│   │   └── user.py                   # Обновлена схема
│   └── api/
│       └── crud_users.py             # Обновлен эндпоинт
├── migrations/
│   ├── add_background_display_settings.sql           # SQL миграция
│   └── run_background_display_settings_migration.py  # Скрипт миграции
└── MIGRATION_BACKGROUND_DISPLAY_SETTINGS.md          # Документация миграции
```

## Безопасность

- Требуется премиум подписка для загрузки фонового изображения
- Валидация параметров на backend:
  - `scale`: 50-200 (целое число)
  - `position_x`: 0-100 (целое число)
  - `position_y`: 0-100 (целое число)
- Валидация файла:
  - Тип: только изображения
  - Размер: макс 1 МБ
  - Разрешение: точно 1200x350 px

## Совместимость

- **Backend**: PostgreSQL 12+, Python 3.11+
- **Frontend**: React 18+, Vite 4+
- **Браузеры**: Chrome 90+, Firefox 88+, Safari 14+, Edge 90+

## Особенности реализации

1. **Drag & Drop позиционирование**
   - Использует нативные события мыши (mousedown, mousemove, mouseup)
   - Плавное перемещение с расчетом позиции в процентах

2. **Реактивный предпросмотр**
   - Изменения применяются мгновенно через CSS background
   - Поддержка всех настроек в реальном времени

3. **Сохранение настроек**
   - Параметры сохраняются в БД вместе с URL изображения
   - Применяются автоматически при отображении профиля

4. **Кэширование**
   - Кэш профиля очищается после загрузки изображения
   - Гарантирует актуальность данных

## Известные ограничения

- Редактор работает только для новых загрузок (нельзя редактировать уже загруженное изображение без повторной загрузки)
- Параметры применяются ко всему изображению (нет обрезки или кадрирования)
- Требуется JavaScript для работы редактора

## Будущие улучшения

- [ ] Возможность редактирования существующего фона без повторной загрузки
- [ ] Поддержка обрезки изображения
- [ ] Поворот изображения
- [ ] Фильтры и эффекты
- [ ] Предустановленные шаблоны позиционирования
- [ ] История изменений с откатом

## Поддержка

При возникновении проблем:
1. Проверьте, что миграция применена
2. Проверьте логи backend на наличие ошибок
3. Убедитесь, что у пользователя есть премиум подписка
4. Проверьте размер и формат файла изображения
