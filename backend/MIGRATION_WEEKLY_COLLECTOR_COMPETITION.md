# Миграция: Недельный конкурс коллекционеров

## Описание
Реализована система недельных циклов конкурса "Топ коллекционеров" с автоматической выдачей бейджей в конце каждого цикла.

## Изменения

### База данных
- Создана таблица `collector_competition_cycle` для отслеживания недельных циклов
- Поля:
  - `leader_user_id` - ID пользователя-лидера на момент начала цикла
  - `cycle_start_date` - Дата начала цикла
  - `cycle_end_date` - Дата окончания цикла (через 7 дней)
  - `is_active` - Активен ли цикл в данный момент
  - `badge_awarded` - Выдан ли бейдж лидеру этого цикла

### Backend

#### Новая модель
- `CollectorCompetitionCycleModel` - модель для недельных циклов

#### Обновленные функции

1. **`get_or_create_current_cycle()`** (новая)
   - Получает текущий активный цикл или создает новый
   - При завершении старого цикла:
     - Завершает старый цикл (`is_active = False`)
     - Выдает бейдж лидеру завершенного цикла
     - Забирает бейдж у предыдущего владельца
     - Создает новый цикл с текущим топ-1 пользователем

2. **`update_collector_badge()`** (обновлена)
   - Теперь вызывается автоматически при завершении цикла
   - Выдает бейдж лидеру завершенной недели

3. **`get_user_most_favorited()`** (обновлена)
   - Возвращает список пользователей и информацию о текущем цикле
   - Добавляет поле `is_cycle_leader` для пользователя-лидера цикла

4. **API endpoint `/user/most-favorited`** (обновлен)
   - Возвращает информацию о текущем цикле в поле `cycle_info`
   - Кэширование:
     - **15 минут** (900 секунд) во время активной недели
     - **1 неделя** (604800 секунд) вне активной недели
   - Автоматически очищает кэш при завершении цикла

### Frontend

#### Обновления в `TopUsersSection.jsx`

1. **Автоматическое обновление данных**
   - Во время активной недели: обновление каждые 15 минут
   - Вне активной недели: обновление по кэшу (1 неделя)

2. **Обработка информации о цикле**
   - Определяет активность недели на основе `cycle_info`
   - Устанавливает интервал обновления только во время активной недели

3. **Кэширование**
   - Адаптивное время кэширования в зависимости от активности недели
   - Автоматическая очистка кэша при получении обновленных данных

## Логика работы

### Начало нового цикла

1. При первом запросе топ пользователей проверяется наличие активного цикла
2. Если цикл истек или отсутствует:
   - Определяется текущий топ-1 пользователь по количеству избранных аниме
   - Создается новый цикл на 7 дней
   - Лидер цикла помечается в данных (`is_cycle_leader = true`)

### Во время активной недели

1. Показываются 6 конкурентов (включая лидера)
2. Данные обновляются каждые 15 минут
3. Лидер недели отображается с пометкой в данных

### Завершение недели

1. При следующем запросе после окончания цикла:
   - Старый цикл завершается (`is_active = False`)
   - Лидеру завершенной недели выдается бейдж "Коллекционер #1" на 1 неделю
   - Бейдж забирается у предыдущего владельца (если был)
   - Определяется новый лидер и создается новый цикл
   - Кэш Redis очищается для получения актуальных данных

## Выполнение миграции

1. Запустить SQL миграцию:
```bash
cd backend/migrations
python run_collector_competition_migration.py
```

2. Перезапустить backend сервер для применения изменений в коде

3. Фронтенд автоматически получит обновления при следующей сборке

## Особенности

- Первый цикл создается автоматически при первом запросе
- Бейдж выдается только в конце недели (не в начале)
- Данные обновляются чаще во время активной недели для показа актуальной конкурентной борьбы
- Кэширование адаптируется в зависимости от активности недели
