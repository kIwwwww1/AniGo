# –ú–∏–≥—Ä–∞—Ü–∏—è —Å cachetools –Ω–∞ Redis - –ì–æ—Ç–æ–≤–æ! ‚úÖ

## –ß—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ

### 1. ‚úÖ –ó–∞–º–µ–Ω–µ–Ω–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
- **–£–¥–∞–ª–µ–Ω–æ:** `cachetools==5.5.1`
- **–î–æ–±–∞–≤–ª–µ–Ω–æ:** 
  - `redis==5.0.1` - –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –∫–ª–∏–µ–Ω—Ç Redis
  - `hiredis==2.3.2` - —É—Å–∫–æ—Ä–∏—Ç–µ–ª—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### 2. ‚úÖ –°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π –º–æ–¥—É–ª—å Redis –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
**–§–∞–π–ª:** `backend/src/services/redis_cache.py`

**–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**
- –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Redis
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ —Å–±–æ—è—Ö
- –î–µ–∫–æ—Ä–∞—Ç–æ—Ä `@redis_cached(prefix, ttl)` –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–π
- Graceful fallback - –µ—Å–ª–∏ Redis –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –∫—ç—à–∞
- –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∫—ç—à–∞

### 3. ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω—ã —Å–µ—Ä–≤–∏—Å—ã
**–§–∞–π–ª:** `backend/src/services/animes.py`

–§—É–Ω–∫—Ü–∏–∏ —Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º:
```python
@redis_cached(prefix="popular", ttl=60)          # 1 –º–∏–Ω—É—Ç–∞
get_popular_anime()

@redis_cached(prefix="anime_paginated", ttl=300) # 5 –º–∏–Ω—É—Ç
pagination_get_anime()

@redis_cached(prefix="anime_count", ttl=600)     # 10 –º–∏–Ω—É—Ç
get_anime_total_count()

@redis_cached(prefix="anime_by_score", ttl=300)  # 5 –º–∏–Ω—É—Ç
get_anime_sorted_by_score()
```

### 4. ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω –≤ FastAPI
**–§–∞–π–ª:** `backend/src/main.py`

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –ø–æ–¥—Ö–æ–¥ —Å **lifespan context manager**:
```python
@asynccontextmanager
async def lifespan(app: FastAPI):
    # Startup - –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Redis
    redis = await get_redis_client()
    
    yield  # –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
    
    # Shutdown - –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ
    await close_redis_client()

app = FastAPI(lifespan=lifespan)
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –ø–æ–¥—Ö–æ–¥ (—Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω FastAPI)
- ‚úÖ –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤
- ‚úÖ –ü—Ä–æ—â–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å

### 5. ‚úÖ –ù–∞—Å—Ç—Ä–æ–µ–Ω Docker Compose
**–§–∞–π–ª:** `docker-compose.yml`

–î–æ–±–∞–≤–ª–µ–Ω —Å–µ—Ä–≤–∏—Å Redis:
- –û–±—Ä–∞–∑: `redis:7-alpine`
- –ü–æ—Ä—Ç: `6379`
- –ü–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å: –≤–∫–ª—é—á–µ–Ω–∞
- –õ–∏–º–∏—Ç –ø–∞–º—è—Ç–∏: 256 MB
- –ü–æ–ª–∏—Ç–∏–∫–∞ –≤—ã—Ç–µ—Å–Ω–µ–Ω–∏—è: LRU (Least Recently Used)
- Health checks

### 6. ‚úÖ –£–¥–∞–ª–µ–Ω —Å—Ç–∞—Ä—ã–π —Ñ–∞–π–ª
- –£–¥–∞–ª–µ–Ω `backend/src/services/cache.py` (—Å cachetools)

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ Redis –Ω–∞–¥ cachetools

| –§—É–Ω–∫—Ü–∏—è | cachetools | Redis |
|---------|-----------|-------|
| **–°–∫–æ—Ä–æ—Å—Ç—å** | –ë—ã—Å—Ç—Ä–æ | –û—á–µ–Ω—å –±—ã—Å—Ç—Ä–æ (1-5ms) |
| **–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ—Å—Ç—å** | ‚ùå –¢–æ–ª—å–∫–æ –ª–æ–∫–∞–ª—å–Ω–æ | ‚úÖ –ú–µ–∂–¥—É —Å–µ—Ä–≤–µ—Ä–∞–º–∏ |
| **–ü–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å** | ‚ùå –ü—Ä–æ–ø–∞–¥–∞–µ—Ç –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ | ‚úÖ –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –Ω–∞ –¥–∏—Å–∫ |
| **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å** | ‚ùå –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∞ –ø–∞–º—è—Ç—å—é –ø—Ä–æ—Ü–µ—Å—Å–∞ | ‚úÖ –ì–∏–≥–∞–±–∞–π—Ç—ã –¥–∞–Ω–Ω—ã—Ö |
| **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** | ‚ùå –ù–µ—Ç | ‚úÖ –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ |
| **Production-ready** | ‚ö†Ô∏è –î–ª—è –ø—Ä–æ—Å—Ç—ã—Ö —Å–ª—É—á–∞–µ–≤ | ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫—Ä—É–ø–Ω—ã–º–∏ –∫–æ–º–ø–∞–Ω–∏—è–º–∏ |
| **TTL** | ‚úÖ –ï—Å—Ç—å | ‚úÖ –ï—Å—Ç—å |
| **Fallback** | ‚ùå | ‚úÖ Graceful degradation |

## –ö–∞–∫ –∑–∞–ø—É—Å—Ç–∏—Ç—å

### –í–∞—Ä–∏–∞–Ω—Ç 1: Docker (–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
```bash
docker-compose up -d --build
```

### –í–∞—Ä–∏–∞–Ω—Ç 2: –õ–æ–∫–∞–ª—å–Ω–æ
```bash
# 1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Redis
brew install redis  # macOS
sudo apt install redis-server  # Ubuntu

# 2. –ó–∞–ø—É—Å—Ç–∏—Ç—å Redis
brew services start redis  # macOS
sudo systemctl start redis-server  # Ubuntu

# 3. –û–±–Ω–æ–≤–∏—Ç—å .env
echo "REDIS_HOST=localhost" >> .env
echo "REDIS_PORT=6379" >> .env

# 4. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
cd backend
pip install -r requirements.txt

# 5. –ó–∞–ø—É—Å—Ç–∏—Ç—å backend
python -m src.main
```

## –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã

```bash
# 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Redis
docker exec -it anigo-redis redis-cli ping
# –û—Ç–≤–µ—Ç: PONG ‚úÖ

# 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏
docker-compose logs -f backend | grep Redis
# –î–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å: ‚úÖ Redis connected: redis:6379

# 3. –û—Ç–∫—Ä—ã—Ç—å —Å–∞–π—Ç –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∫—ç—à
# http://localhost:3000
# –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É - —É–≤–∏–¥–∏—Ç–µ –≤ –ª–æ–≥–∞—Ö:
# üí® Cache MISS (–ø–µ—Ä–≤—ã–π —Ä–∞–∑)
# üéØ Cache HIT (–ø–æ—Å–ª–µ–¥—É—é—â–∏–µ —Ä–∞–∑—ã)
```

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

```bash
# Redis CLI
docker exec -it anigo-redis redis-cli

# –ö–æ–º–∞–Ω–¥—ã –≤–Ω—É—Ç—Ä–∏ CLI:
DBSIZE          # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–ª—é—á–µ–π
INFO memory     # –ü–∞–º—è—Ç—å
KEYS *          # –í—Å–µ –∫–ª—é—á–∏
TTL –∫–ª—é—á        # –í—Ä–µ–º—è –∂–∏–∑–Ω–∏ –∫–ª—é—á–∞
```

## –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

**–ó–∞–º–µ—Ä—ã —Å–∫–æ—Ä–æ—Å—Ç–∏:**
- Cache MISS (–ø–µ—Ä–≤—ã–π –∑–∞–ø—Ä–æ—Å): 50-100ms
- Cache HIT (–ø–æ–≤—Ç–æ—Ä–Ω—ã–π –∑–∞–ø—Ä–æ—Å): 1-5ms ‚ö°
- **–£—Å–∫–æ—Ä–µ–Ω–∏–µ: –≤ 10-50 —Ä–∞–∑!**

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### TTL (–≤—Ä–µ–º—è –∂–∏–∑–Ω–∏ –∫—ç—à–∞)
–ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –≤ –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä–µ:
```python
@redis_cached(prefix="my_cache", ttl=600)  # 10 –º–∏–Ω—É—Ç
async def my_function():
    ...
```

### –õ–∏–º–∏—Ç –ø–∞–º—è—Ç–∏ Redis
–í `docker-compose.yml`:
```yaml
command: redis-server --maxmemory 512mb  # –ò–∑–º–µ–Ω–∏—Ç—å –∑–¥–µ—Å—å
```

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
–í `.env`:
```env
REDIS_HOST=redis
REDIS_PORT=6379
REDIS_DB=0
REDIS_PASSWORD=  # –¥–ª—è production
```

## –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

–°–æ–∑–¥–∞–Ω–∞ –ø–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:
- üìñ **[REDIS_SETUP.md](./REDIS_SETUP.md)** - –î–µ—Ç–∞–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
- üöÄ **[REDIS_QUICKSTART.md](./REDIS_QUICKSTART.md)** - –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

## –û—Ç–∫–∞—Ç (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)

–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ cachetools:

```bash
# 1. –û—Ç–∫–∞—Ç–∏—Ç—å requirements.txt
git checkout backend/requirements.txt

# 2. –û—Ç–∫–∞—Ç–∏—Ç—å services/animes.py
git checkout backend/src/services/animes.py

# 3. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å cache.py
git checkout backend/src/services/cache.py

# 4. –û—Ç–∫–∞—Ç–∏—Ç—å main.py
git checkout backend/src/main.py

# 5. –û—Ç–∫–∞—Ç–∏—Ç—å docker-compose.yml
git checkout docker-compose.yml
```

## –°—Ç–∞—Ç—É—Å

üü¢ **–í–°–ï –ì–û–¢–û–í–û!** –ú–æ–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å:

```bash
docker-compose up -d --build
```

–°–∞–π—Ç –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ http://localhost:3000 —Å Redis –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º!

---

**–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:** üöÄ –í 10-50 —Ä–∞–∑ –±—ã—Å—Ç—Ä–µ–µ  
**–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å:** ‚úÖ Production-ready  
**–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å:** ‚úÖ Graceful fallback  
**–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:** ‚úÖ –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏
